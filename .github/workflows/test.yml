name: Master Tool

on:
  workflow_call:
    secrets:
      github_actions_token:
        description: 'GAT'
        required: true
    inputs:
      is-merge-request:
        description: 'テストflg'
        type: boolean
        default: false

env:
  TEMP_BRANCH: pull/${{ github.event.pull_request.number }}/tool
  GH_HOST: github.com
  GH_REPO: ${{ github.repository }}
  GH_TOKEN: ${{ secrets.github_actions_token }}
  PR_NUMBER: ${{ github.event.number }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Install gh
      run: |
        sudo apt-get update
        sudo apt-get install -y gh

    - name: Debug gh auth
      run: gh auth status || true

    - name: Remove Label
      if: ${{ github.event.label.name != 'テスト実行3' && !inputs.is-after-merge-request }}
      run: gh pr edit ${{ github.event.pull_request.number }} --remove-label ${{ github.event.label.name }}
    
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: false
        ref: ${{ github.head_ref }}
        persist-credentials: false
      
    - name: マージ
      id: merge
      run: |
        git config --local user.email "yamazaki.yukari.0416@gmail.com"
        git config --local user.name "pomzaki"
        git config --global url.https://x-access-token:${{ secrets.github_actions_token }}@github.com/.insteadOf https://github.com/
        
        GIT_ASKPASS="/tmp/.git-askpass" git merge --no-ff origin/$base
      continue-on-error: true
      env:
        base: ${{ github.event.pull_request.base.ref }}
      
    - name: Append text to file
      run: echo "a" >> test.txt
      
    - name: Commit and push changes
      run: |
        git config --local user.email "yamazaki.yukari.0416@gmail.com"
        git config --local user.name "pomzaki"
        git config --global url.https://x-access-token:${{ secrets.github_actions_token }}@github.com/.insteadOf https://github.com/
        git add test.txt
        git commit -m "Add 'a' to test.txt"
        git push --force-with-lease origin HEAD:refs/heads/${{ github.event.pull_request.head.ref }}

    - name: その後、マージを実行する
      run: |

        # コミット後の情報更新に時間がかかる可能性があるため、計算が終わる(UNKNOWNでなくなる)まで最大30秒待機
        for i in {1..6}; do
          MERGEABLE=$(gh pr view "${{ github.event.pull_request.number }}" --repo "$GH_REPO" --json mergeable --jq .mergeable)
          MS=$(gh pr view "${{ github.event.pull_request.number }}" --repo "$GH_REPO" --json mergeStateStatus --jq .mergeStateStatus)
          echo "$MS / $MERGEABLE"

          if [ "$MERGEABLE" != "UNKNOWN" ] && [ "$MS" != "UNKNOWN" ]; then
            break
          fi
          echo "Waiting for mergeability check..."
          sleep 5
        done

        gh pr view "${{ github.event.pull_request.number }}" \
          --json state,mergeable,mergeStateStatus,isDraft,reviewDecision,statusCheckRollup,autoMergeRequest,mergedAt \
          --jq '{state, mergedAt, mergeable, mergeStateStatus, isDraft, reviewDecision, autoMergeEnabled:(.autoMergeRequest!=null), checks:(.statusCheckRollup|length)}'

        gh pr merge ${{ github.event.pull_request.number }} --merge --auto

        for i in {1..6}; do

          MERGEABLE=$(gh pr view "${{ github.event.pull_request.number }}" --repo "$GH_REPO" --json mergeable --jq .mergeable)
          MS=$(gh pr view "${{ github.event.pull_request.number }}" --repo "$GH_REPO" --json mergeStateStatus --jq .mergeStateStatus)
          echo "$MS / $MERGEABLE"

          if [ "$MERGEABLE" != "UNKNOWN" ] && [ "$MS" != "UNKNOWN" ]; then
            break
          fi
          echo "Waiting for mergeability check..."
          sleep 5
        done

        gh pr view "${{ github.event.pull_request.number }}" \
          --json state,mergeable,mergeStateStatus,isDraft,reviewDecision,statusCheckRollup,autoMergeRequest,mergedAt \
          --jq '{state, mergedAt, mergeable, mergeStateStatus, isDraft, reviewDecision, autoMergeEnabled:(.autoMergeRequest!=null), checks:(.statusCheckRollup|length)}'

