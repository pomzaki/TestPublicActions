name: Master Tool

on:
  workflow_call:
    secrets:
      github_actions_token:
        description: 'GAT'
        required: true
    inputs:
      is-merge-request:
        description: 'テストflg'
        type: boolean
        default: false

env:
  TEMP_BRANCH: pull/${{ github.event.pull_request.number }}/tool
  GH_HOST: github.com
  GH_REPO: ${{ github.repository }}
  GH_TOKEN: ${{ secrets.github_actions_token }}
  PR_NUMBER: ${{ github.event.number }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Install gh
      run: |
        sudo apt-get update
        sudo apt-get install -y gh

    - name: Debug gh auth
      run: gh auth status || true

    - name: Remove Label
      if: ${{ github.event.label.name != 'テスト実行3' && !inputs.is-after-merge-request }}
      run: gh pr edit ${{ github.event.pull_request.number }} --remove-label ${{ github.event.label.name }}
    
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: false
        ref: ${{ github.head_ref }}
        persist-credentials: false
      
    - name: マージ
      id: merge
      run: |
        git config --local user.email "yamazaki.yukari.0416@gmail.com"
        git config --local user.name "pomzaki"
        git config --global url.https://x-access-token:${{ secrets.github_actions_token }}@github.com/.insteadOf https://github.com/
        
        GIT_ASKPASS="/tmp/.git-askpass" git merge --no-ff origin/$base
      continue-on-error: true
      env:
        base: ${{ github.event.pull_request.base.ref }}
      
    - name: Append text to file
      run: echo "a" >> test.txt
      
    - name: Commit and push changes
      run: |
        git config --local user.email "yamazaki.yukari.0416@gmail.com"
        git config --local user.name "pomzaki"
        git config --global url.https://x-access-token:${{ secrets.github_actions_token }}@github.com/.insteadOf https://github.com/
        git add test.txt
        git commit -m "Add 'a' to test.txt"
        git push --force-with-lease origin HEAD:refs/heads/${{ github.event.pull_request.head.ref }}

    - name: その後、マージを実行する
      run: |

        # --- helper: PR状態を一度で取得 ---
        fetch_pr_state() {
          _PR_JSON=$(gh pr view "${{ github.event.pull_request.number }}" --repo "$GH_REPO" \
            --json state,mergedAt,mergeable,mergeStateStatus,isDraft,reviewDecision,autoMergeRequest)
          MERGEABLE=$(echo "$_PR_JSON" | jq -r .mergeable)
          MS=$(echo "$_PR_JSON" | jq -r .mergeStateStatus)
          STATE=$(echo "$_PR_JSON" | jq -r .state)
          AUTO_MERGE_ENABLED=$(echo "$_PR_JSON" | jq -r '(.autoMergeRequest != null)')
          echo "autoMergeEnabled=$AUTO_MERGE_ENABLED"
          echo "$_PR_JSON"
        }

        echo "--- 1"
        # 初回状態チェック
        fetch_pr_state

        echo "--- 2"
        # コミット後の情報更新に時間がかかる可能性があるため、計算が終わる(UNKNOWNでなくなる)まで最大30秒待機
        for i in {1..6}; do

          fetch_pr_state
          echo "$MS / $MERGEABLE / $STATE"

          if [ "$STATE" = "MERGED" ]; then
            echo "Already merged -> skipping second auto-merge call"
            exit 0
          fi

          if [ "$MERGEABLE" != "UNKNOWN" ] && [ "$MS" != "UNKNOWN" ]; then
            break
          fi
          echo "Waiting for mergeability check..."
          sleep 5
        done

        # gh pr view "${{ github.event.pull_request.number }}" \
        #   --json state,mergeable,mergeStateStatus,isDraft,reviewDecision,statusCheckRollup,autoMergeRequest,mergedAt \
        #   --jq '{state, mergedAt, mergeable, mergeStateStatus, isDraft, reviewDecision, autoMergeEnabled:(.autoMergeRequest!=null), checks:(.statusCheckRollup|length)}'

        # auto-merge を有効化（登録フェーズ）
        gh pr merge ${{ github.event.pull_request.number }} --repo "$GH_REPO" --merge --auto

        echo "--- 3"
        for i in {1..6}; do

          fetch_pr_state
          echo "$MS / $MERGEABLE / $STATE"

          if [ "$STATE" = "MERGED" ]; then
            echo "Already merged -> skipping second auto-merge call"
            exit 0
          fi

          if [ "$MERGEABLE" != "UNKNOWN" ] && [ "$MS" != "UNKNOWN" ]; then
            break
          fi
          echo "Waiting for mergeability check..."
          sleep 5
        done

        echo "--- 4"
        fetch_pr_state
        # gh pr view "${{ github.event.pull_request.number }}" \
        #   --json state,mergeable,mergeStateStatus,isDraft,reviewDecision,statusCheckRollup,autoMergeRequest,mergedAt \
        #   --jq '{state, mergedAt, mergeable, mergeStateStatus, isDraft, reviewDecision, autoMergeEnabled:(.autoMergeRequest!=null), checks:(.statusCheckRollup|length)}'

        gh pr merge ${{ github.event.pull_request.number }} --repo "$GH_REPO" --merge --auto

        echo "--- 5"
        fetch_pr_state
        # gh pr view "${{ github.event.pull_request.number }}" \
        #   --json state,mergeable,mergeStateStatus,isDraft,reviewDecision,statusCheckRollup,autoMergeRequest,mergedAt \
        #   --jq '{state, mergedAt, mergeable, mergeStateStatus, isDraft, reviewDecision, autoMergeEnabled:(.autoMergeRequest!=null), checks:(.statusCheckRollup|length)}'

