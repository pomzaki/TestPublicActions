name: automerge-check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
env:
  GH_HOST: github.com
  GH_REPO: ${{ github.repository }}
  GH_TOKEN: ${{ github.token }}

permissions:
  pull-requests: read

jobs:
  check-action:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
    
      - name: Install gh
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Debug gh auth
        run: gh auth status || true

      - name: Detect auto-merge label and write summary
        run: |
          set -e

          # Change this to the label name you use to trigger auto-merge
          AUTO_MERGE_LABEL="テスト実行1"

          EVENT_ACTION="${{ github.event.action }}"
          EVENT_LABEL_NAME="${{ github.event.label.name || '' }}"

          echo "Event action: $EVENT_ACTION"
          echo "Event label:  $EVENT_LABEL_NAME"

          ARMED=false

          # 1) If this run was triggered by label add/remove, trust the event payload.
          # NOTE: The auto-merge workflow may remove the label immediately, causing a subsequent "unlabeled" run.
          # We treat both as "armed" because "unlabeled" here means the trigger label was consumed.
          if { [ "$EVENT_ACTION" = "labeled" ] || [ "$EVENT_ACTION" = "unlabeled" ]; } && \
             [ "$EVENT_LABEL_NAME" = "$AUTO_MERGE_LABEL" ]; then
            ARMED=true
            if [ "$EVENT_ACTION" = "labeled" ]; then
              echo "Auto-merge label detected from event payload (labeled)."
            else
              echo "Auto-merge label detected from event payload (unlabeled / consumed)."
            fi
          fi

          # 2) Fallback: check current labels on PR (for opened/synchronize/reopened)
          if [ "$ARMED" = false ]; then
            PR_JSON=$(gh pr view "${{ github.event.pull_request.number }}" --repo "$GH_REPO" --json labels 2>&1)
            echo "gh pr view --json labels raw:"
            echo "$PR_JSON"

            labels=$(echo "$PR_JSON" | jq -r '.labels[].name // empty' || true)

            echo "Labels on PR:"
            echo "$labels"

            if echo "$labels" | grep -qx "$AUTO_MERGE_LABEL"; then
              ARMED=true
              echo "Auto-merge label detected from current labels."
            fi
          fi

          # Write summary
          if [ "$ARMED" = true ]; then
            {
              echo "### ✅ Auto-merge: armed（ラベル検知済み）"
              echo ""
              echo "- Trigger label: \`$AUTO_MERGE_LABEL\`"
              if [ "$EVENT_ACTION" = "labeled" ]; then
                echo "- Detection source: event payload (labeled)"
              elif [ "$EVENT_ACTION" = "unlabeled" ]; then
                echo "- Detection source: event payload (unlabeled / consumed)"
              else
                echo "- Detection source: current labels"
              fi
              echo "- This check exists to provide a stable trigger and visibility for auto-merge."
              echo "- The auto-merge tool workflow will attempt to merge this PR when mergeability is determined."
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "### ℹ️ Auto-merge: not armed"
              echo ""
              echo "- Trigger label (\`$AUTO_MERGE_LABEL\`) is not present on this PR."
              echo "- Event action: \`$EVENT_ACTION\`"
            } >> "$GITHUB_STEP_SUMMARY"
          fi