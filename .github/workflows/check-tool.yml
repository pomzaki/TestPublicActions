name: automerge-check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
env:
  GH_HOST: github.com
  GH_REPO: ${{ github.repository }}
  GH_TOKEN: ${{ github.token }}

permissions:
  pull-requests: read

jobs:
  check-action:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
    
      - name: Install gh
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Debug gh auth
        run: gh auth status || true

      - name: Detect auto-merge label and write summary
        run: |
          set -e

          # Change this to the label name you use to trigger auto-merge
          AUTO_MERGE_LABEL="テスト実行1"

          # Fetch labels JSON (force repo because we didn't checkout the repo, so gh can't infer it reliably)
          PR_JSON=$(gh pr view "${{ github.event.pull_request.number }}" --repo "$GH_REPO" --json labels 2>&1)
          echo "gh pr view --json labels raw:"
          echo "$PR_JSON"

          # Extract label names (if no labels, this becomes empty)
          labels=$(echo "$PR_JSON" | jq -r '.labels[].name // empty' || true)

          echo "Labels on PR:"
          echo "$labels"

          if echo "$labels" | grep -qx "$AUTO_MERGE_LABEL"; then
            {
              echo "### ✅ Auto-merge: armed（ラベル検知済み）"
              echo ""
              echo "- Trigger label: \`$AUTO_MERGE_LABEL\`"
              echo "- This check exists to provide a stable trigger and visibility for auto-merge."
              echo "- The auto-merge tool workflow will attempt to merge this PR when mergeability is determined."
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "### ℹ️ Auto-merge: not armed"
              echo ""
              echo "- Trigger label (\`$AUTO_MERGE_LABEL\`) is not present on this PR."
            } >> "$GITHUB_STEP_SUMMARY"
          fi